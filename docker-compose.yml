services:
  nginx:
    image: nginx:alpine
    container_name: pivni-konto-nginx
    ports:
      - "80:80"
    volumes:
      - ./backend/public:/var/www/html/public:ro
      - ./frontend/dist:/var/www/html/frontend:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - php
    networks:
      - pivni-konto

  php:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: pivni-konto-php
    volumes:
      - ./backend:/var/www/html
    depends_on:
      - postgres
      - redis
    environment:
      APP_ENV: dev
      APP_SECRET: ${APP_SECRET:-change_this_secret_in_production}
      DATABASE_URL: postgresql://pivnikonto:pivnikonto@postgres:5432/pivnikonto?serverVersion=16&charset=utf8
      REDIS_URL: redis://redis:6379
      JWT_SECRET_KEY: '%kernel.project_dir%/config/jwt/private.pem'
      JWT_PUBLIC_KEY: '%kernel.project_dir%/config/jwt/public.pem'
      JWT_PASSPHRASE: ${JWT_PASSPHRASE:-pivnikonto}
      CORS_ALLOW_ORIGIN: "^https?://(localhost|127\\.0\\.0\\.1)(:[0-9]+)?$$"
      MAILER_DSN: ${MAILER_DSN:-null://null}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
    networks:
      - pivni-konto

  postgres:
    image: postgres:16-alpine
    container_name: pivni-konto-postgres
    environment:
      POSTGRES_DB: pivnikonto
      POSTGRES_USER: pivnikonto
      POSTGRES_PASSWORD: pivnikonto
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    networks:
      - pivni-konto

  redis:
    image: redis:alpine
    container_name: pivni-konto-redis
    volumes:
      - redis_data:/data
    networks:
      - pivni-konto

  cron:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: pivni-konto-cron
    user: root
    volumes:
      - ./backend:/var/www/html
    depends_on:
      - postgres
      - redis
    environment:
      APP_ENV: dev
      APP_SECRET: ${APP_SECRET:-change_this_secret_in_production}
      DATABASE_URL: postgresql://pivnikonto:pivnikonto@postgres:5432/pivnikonto?serverVersion=16&charset=utf8
      REDIS_URL: redis://redis:6379
      JWT_SECRET_KEY: '%kernel.project_dir%/config/jwt/private.pem'
      JWT_PUBLIC_KEY: '%kernel.project_dir%/config/jwt/public.pem'
      JWT_PASSPHRASE: ${JWT_PASSPHRASE:-pivnikonto}
      CORS_ALLOW_ORIGIN: "^https?://(localhost|127\\.0\\.0\\.1)(:[0-9]+)?$$"
    networks:
      - pivni-konto
    entrypoint: /bin/sh -c "echo '1 5 * * * cd /var/www/html && php bin/console app:evaluate-group-achievements >> /var/log/cron.log 2>&1' | crontab - && crond -f"

  node:
    build:
      context: ./docker/node
      dockerfile: Dockerfile
    container_name: pivni-konto-node
    user: root
    volumes:
      - ./frontend:/app
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost/api
    networks:
      - pivni-konto
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"

volumes:
  postgres_data:
  redis_data:

networks:
  pivni-konto:
    driver: bridge
